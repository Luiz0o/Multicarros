<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Detalhes do Ve√≠culo</title>
    <link rel="stylesheet" href="../css/verDetalhes.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
    <style>
      /* üé® Estilos para loading e estados vazios */
      .loading {
        text-align: center;
        padding: 3rem;
        font-size: 1.2rem;
        color: #666;
      }
      
      .loading::after {
        content: '...';
        animation: dots 1.5s steps(4, end) infinite;
      }
      
      @keyframes dots {
        0%, 20% { content: '.'; }
        40% { content: '..'; }
        60%, 100% { content: '...'; }
      }
      
      .error-message {
        text-align: center;
        padding: 2rem;
        color: #d32f2f;
        font-size: 1.1rem;
      }
      
      .miniaturas img {
        cursor: pointer;
        transition: transform 0.2s, opacity 0.2s;
      }
      
      .miniaturas img:hover {
        transform: scale(1.05);
        opacity: 0.8;
      }
    </style>
  </head>
  <body>
    <!-- HEADER -->
    <header class="topo">
      <div class="topo-logo">
        <img src="../images/multilogo.png" alt="Logo Multicarros" />
        <h2>Detalhes do Ve√≠culo</h2>
      </div>
    </header>

    <!-- CONTE√öDO -->
    <main class="detalhes-container">
      <!-- üñºÔ∏è GALERIA DE FOTOS -->
      <div class="galeria">
        <img
          src="../images/default-car.jpg"
          alt="Carregando..."
          class="foto-principal"
          id="fotoPrincipal"
        />
        <div class="miniaturas" id="miniaturas">
          <!-- Miniaturas ser√£o carregadas dinamicamente -->
        </div>
      </div>

      <!-- üìã INFORMA√á√ïES DO VE√çCULO -->
      <div class="info-veiculo">
        <h1 id="titulo">Carregando informa√ß√µes...</h1>
        <p class="preco" id="preco">---</p>

        <table class="tabela-info" id="tabela">
          <tr>
            <td colspan="2" class="loading">Carregando detalhes</td>
          </tr>
        </table>

        <button class="btn-voltar" onclick="history.back()">‚¨Ö Voltar</button>
      </div>
    </main>

    <!-- BOT√ÉO WHATSAPP FIXO -->
    <a
      href="https://wa.me/55619840002200"
      class="whatsapp-float"
      target="_blank"
      title="Falar no WhatsApp"
      id="whatsappLink"
    >
      <i class="fa-brands fa-whatsapp"></i>
    </a>

    <!-- ‚öôÔ∏è SCRIPT PARA CARREGAR DETALHES -->
    <script>
      
(function () {
  console.log("üöÄ Iniciando carregamento de detalhes do ve√≠culo...");

  // üîß FUN√á√ïES AUXILIARES
  function getQueryParam(name) {
    const params = new URLSearchParams(window.location.search);
    return params.get(name);
  }

  function escapeHtml(s) {
    const div = document.createElement('div');
    div.textContent = s || '';
    return div.innerHTML;
  }

  function formatarPreco(valor) {
    if (!valor || isNaN(valor)) return "Consulte";
    return `R$ ${Number(valor).toLocaleString("pt-BR", {
      minimumFractionDigits: 2,
      maximumFractionDigits: 2
    })}`;
  }

  function formatarKm(km) {
    if (!km || isNaN(km)) return "---";
    return `${Number(km).toLocaleString("pt-BR")} Km`;
  }

  // üìç ELEMENTOS DO DOM
  const fotoPrincipal = document.getElementById("fotoPrincipal");
  const miniaturas = document.getElementById("miniaturas");
  const titulo = document.getElementById("titulo");
  const precoEl = document.getElementById("preco");
  const tabela = document.getElementById("tabela");
  const whatsappLink = document.getElementById("whatsappLink");

  // üÜî PEGAR ID DA URL
  const veiculoId = getQueryParam("id");
  
  if (!veiculoId) {
    console.error("‚ùå Nenhum ID de ve√≠culo fornecido na URL");
    titulo.textContent = "Nenhum ve√≠culo selecionado";
    precoEl.textContent = "---";
    tabela.innerHTML = `
      <tr>
        <td colspan="2" class="error-message">
          ‚ö†Ô∏è Nenhum ve√≠culo selecionado. 
          <a href="/HTML/index.html">Voltar para a home</a>
        </td>
      </tr>
    `;
    return;
  }

  console.log(`üîç Buscando ve√≠culo ID: ${veiculoId}`);

  // üé® FUN√á√ÉO PARA RENDERIZAR O VE√çCULO
  function renderizarVeiculo(veiculo) {
    console.log("‚úÖ Renderizando ve√≠culo:", veiculo);

    // üöó NOME COMPLETO
    const marca = veiculo.marca || "";
    const modelo = veiculo.modelo || "";
    const nomeCompleto = `${marca} ${modelo}`.trim() || "Ve√≠culo";
    
    const cambio = veiculo.cambio === "automatico" ? "Autom√°tico" : "Manual";
    const tituloCompleto = `${nomeCompleto} - ${cambio}`;

    // üí∞ PRE√áO
    const preco = formatarPreco(veiculo.preco);

    // üì∏ FOTO PRINCIPAL
    let fotoPrincipalUrl = "../images/default-car.jpg";
    
    if (veiculo.foto_principal) {
      fotoPrincipalUrl = veiculo.foto_principal;
    } else if (veiculo.fotos && veiculo.fotos.length > 0) {
      fotoPrincipalUrl = veiculo.fotos[0].url;
    }

    // ‚úèÔ∏è ATUALIZA ELEMENTOS
    titulo.textContent = tituloCompleto;
    precoEl.textContent = preco;
    fotoPrincipal.src = fotoPrincipalUrl;
    fotoPrincipal.alt = nomeCompleto;
    fotoPrincipal.onerror = function() {
      this.src = "../images/default-car.jpg";
    };

    // üìã TABELA DE INFORMA√á√ïES
    const dadosTabela = [
      ["Combust√≠vel", veiculo.combustivel || "---"],
      ["Cor", veiculo.cor || "---"],
      ["Placa", veiculo.placa || "---"],
      ["Quilometragem", formatarKm(veiculo.km)],
      ["Ano Fabrica√ß√£o", veiculo.fabricacao || "---"],
      ["Ano Modelo", veiculo.ano_modelo || "---"],
      ["C√¢mbio", cambio],
      ["Portas", veiculo.portas || "---"],
      ["Status", veiculo.status === "novo" ? "Novo" : "Usado"],
      ["Tipo", veiculo.tipo === "carro" ? "Carro" : "Moto"],

    ];

    // ‚úÖ Adiciona descri√ß√£o se existir
    if (veiculo.descricao) {
      dadosTabela.push(["Descri√ß√£o", veiculo.descricao]);
    }

    tabela.innerHTML = dadosTabela
      .map(([campo, valor]) => `
        <tr>
          <td><strong>${escapeHtml(campo)}</strong></td>
          <td>${escapeHtml(String(valor))}</td>
        </tr>
      `)
      .join("");

    // üñºÔ∏è GALERIA DE MINIATURAS
    miniaturas.innerHTML = "";
    
    if (veiculo.fotos && veiculo.fotos.length > 0) {
      // Ordena por ordem
      const fotosOrdenadas = [...veiculo.fotos].sort((a, b) => 
        (a.ordem || 0) - (b.ordem || 0)
      );

      fotosOrdenadas.forEach((foto, index) => {
        const img = document.createElement("img");
        img.src = foto.url;
        img.alt = `${nomeCompleto} - Foto ${index + 1}`;
        img.onerror = function() {
          this.style.display = 'none';
        };
        
        // Evento de clique para trocar foto principal
        img.addEventListener("click", function () {
          fotoPrincipal.src = this.src;
          // ‚úÖ Remove classe 'active' de todas e adiciona na clicada
          miniaturas.querySelectorAll('img').forEach(i => i.classList.remove('active'));
          this.classList.add('active');
        });

        // ‚úÖ Primeira miniatura j√° vem ativa
        if (index === 0) {
          img.classList.add('active');
        }

        miniaturas.appendChild(img);
      });

      console.log(`üì∏ ${fotosOrdenadas.length} foto(s) carregada(s)`);
    } else {
      // Se n√£o houver fotos, mostra apenas a principal
      const img = document.createElement("img");
      img.src = fotoPrincipalUrl;
      img.alt = nomeCompleto;
      img.classList.add('active');
      miniaturas.appendChild(img);
      
      console.log("‚ÑπÔ∏è Nenhuma galeria de fotos dispon√≠vel");
    }

    // üì± ATUALIZA LINK DO WHATSAPP
    const mensagem = `Ol√°! Gostaria de saber mais sobre o ${nomeCompleto} (Placa: ${veiculo.placa || veiculoId})`;
    whatsappLink.href = `https://wa.me/55619840002200?text=${encodeURIComponent(mensagem)}`;

    console.log("üéâ Ve√≠culo renderizado com sucesso!");
  }

  // üåê BUSCAR VE√çCULO NA API
  // ‚úÖ CORRIGIDO: Usa a rota correta com /completo
  const apiUrl = `http://localhost:3000/veiculos/${veiculoId}/completo`;
  
  console.log(`üì° Fazendo requisi√ß√£o para: ${apiUrl}`);

  fetch(apiUrl, { 
    method: "GET",
    headers: {
      'Accept': 'application/json',
      'Content-Type': 'application/json'
    }
  })
    .then((response) => {
      console.log(`üì• Resposta recebida: HTTP ${response.status}`);
      
      if (response.status === 404) {
        throw new Error("Ve√≠culo n√£o encontrado");
      }
      
      if (response.status === 204) {
        throw new Error("Ve√≠culo n√£o possui dados");
      }
      
      if (!response.ok) {
        throw new Error(`Erro HTTP ${response.status}: ${response.statusText}`);
      }
      
      return response.json();
    })
    .then((data) => {
      console.log("‚úÖ Dados recebidos:", data);
      
      if (!data) {
        throw new Error("Nenhum dado retornado pela API");
      }

      renderizarVeiculo(data);
    })
    .catch((error) => {
      console.error("‚ùå Erro ao buscar ve√≠culo:", error);
      
      // Mostra mensagem de erro amig√°vel
      titulo.textContent = "Ve√≠culo n√£o encontrado";
      precoEl.textContent = "---";
      tabela.innerHTML = `
        <tr>
          <td colspan="2" class="error-message">
            ‚ùå N√£o foi poss√≠vel carregar as informa√ß√µes deste ve√≠culo.<br>
            <small>Erro: ${escapeHtml(error.message)}</small><br><br>
            <a href="/HTML/index.html">‚Üê Voltar para a home</a>
          </td>
        </tr>
      `;
      fotoPrincipal.src = "../images/default-car.jpg";
      miniaturas.innerHTML = "";
    });
})();
    </script>
  </body>
</html>