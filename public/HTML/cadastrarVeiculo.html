<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cadastrar Ve√≠culo - Multicarros Admin</title>
    <link rel="stylesheet" href="/css/cadastrar.css" />
    <style>
      /* Estilos para o preview de m√∫ltiplas fotos */
      .foto-preview {
        display: none;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 10px;
      }
      
      .foto-preview.show {
        display: flex !important;
      }
      
      .foto-item {
        position: relative;
        width: 120px;
        height: 120px;
      }
      
      .foto-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      }
      
      .foto-item .remover {
        position: absolute;
        top: -8px;
        right: -8px;
        background: #d32f2f;
        color: white;
        border: none;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        cursor: pointer;
        font-size: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      }
      
      .foto-item .ordem {
        position: absolute;
        bottom: 5px;
        left: 5px;
        background: rgba(0,0,0,0.7);
        color: white;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: bold;
      }

      /* Barra de progresso */
      #uploadProgress {
        display: none;
        margin: 20px 0;
      }
      
      #uploadProgress.show {
        display: block !important;
      }
      
      #progressContainer {
        background: #e0e0e0;
        border-radius: 8px;
        overflow: hidden;
      }
      
      #progressBar {
        width: 0%;
        height: 30px;
        background: linear-gradient(90deg, #22833d, #2f8f4a);
        transition: width 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        border-radius: 8px;
      }
      
      #progressText {
        text-align: center;
        margin-top: 10px;
        color: #256a38;
        font-weight: bold;
      }

      .foto-count {
        display: inline-block;
        margin-left: 10px;
        color: #22833d;
        font-weight: bold;
        font-size: 14px;
      }

      /* ‚úÖ DESTACAR O NOVO CAMPO */
      .campo-novo {
        position: relative;
      }
      
      .campo-novo::before {
        content: "‚ú® NOVO";
        position: absolute;
        top: -8px;
        right: 10px;
        background: #22833d;
        color: white;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: bold;
        z-index: 1;
      }
    </style>
  </head>
  <body class="auth-bg">
    <a
      href="/HTML/dashboard.html"
      class="btn-voltar-home"
      title="Voltar para Home"
    >
      ‚Üê Voltar
    </a>
    
    <div class="card-cadastro">
      <h2 class="card-titulo">Cadastrar Ve√≠culo üöó</h2>
      
      <!-- Barra de progresso -->
      <div id="uploadProgress">
        <div id="progressContainer">
          <div id="progressBar">0%</div>
        </div>
        <p id="progressText">Preparando upload...</p>
      </div>
      
      <form id="formVeiculo" data-endpoint="http://localhost:3000/veiculos">
        <!-- ‚úÖ CAMPOS MARCA E MODELO SEPARADOS -->
        <div class="form-row">
          <div class="form-group">
            <label>Marca *</label>
            <input 
              type="text" 
              name="marca" 
              required 
              placeholder="Ex: Toyota"
              list="marcas-sugestoes"
            />
            <datalist id="marcas-sugestoes">
              <option value="Audi">
              <option value="BMW">
              <option value="Chevrolet">
              <option value="Fiat">
              <option value="Ford">
              <option value="Honda">
              <option value="Hyundai">
              <option value="Jeep">
              <option value="Nissan">
              <option value="Peugeot">
              <option value="Renault">
              <option value="Toyota">
              <option value="Volkswagen">
            </datalist>
          </div>
          
          <div class="form-group">
            <label>Modelo *</label>
            <input 
              type="text" 
              name="modelo" 
              required 
              placeholder="Ex: Corolla"
            />
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label>Pre√ßo (R$) *</label>
            <input type="number" name="preco" step="0.01" required placeholder="Ex: 85000" />
          </div>
          <div class="form-group">
            <label>Ano Fabrica√ß√£o *</label>
            <input type="number" name="anoFabricacao" min="1900" max="2025" required placeholder="2023" />
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label>Ano Modelo *</label>
            <input type="number" name="anoModelo" min="1900" max="2026" required placeholder="2024" />
          </div>
          <div class="form-group">
            <label>Status *</label>
            <select name="status" required>
              <option value="">-- selecione --</option>
              <option value="novo">Novo</option>
              <option value="usado">Usado</option>
            </select>
          </div>
        </div>
        
        <div class="form-group">
          <label>Esp√©cie *</label>
          <select name="especie" required>
            <option value="">-- selecione --</option>
            <option value="Autom√≥vel">Autom√≥vel</option>
            <option value="Motocicleta">Motocicleta</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>C√¢mbio *</label>
          <select name="cambio" required>
            <option value="">-- selecione --</option>
            <option value="automatico">Autom√°tico</option>
            <option value="manual">Manual</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>Combust√≠vel</label>
          <select name="combustivel">
            <option value="">-- selecione --</option>
            <option value="flex">Flex</option>
            <option value="gasolina">Gasolina</option>
            <option value="etanol">Etanol</option>
            <option value="diesel">Diesel</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>Cor *</label>
          <input type="text" name="cor" required placeholder="Ex: Preto" />
        </div>

         <div class="form-group">
          <label>Portas *</label>
          <input type="number" name="portas" required placeholder="Ex: 4" min="1" />
        </div>
        
        <div class="form-group">
          <label>Placa *</label>
          <input type="text" name="placa" placeholder="ABC1234" required maxlength="7" style="text-transform: uppercase;" />
        </div>
        
        <div class="form-group">
          <label>Chassi * (17 caracteres)</label>
          <input type="text" name="chassi" maxlength="17" required placeholder="9BWZZZ377VT004251" style="text-transform: uppercase;" />
        </div>
        
        <div class="form-group">
          <label>Renavam * (11 d√≠gitos)</label>
          <input type="text" name="renavam" maxlength="11" required placeholder="12345678901" pattern="[0-9]{11}" />
        </div>
        
        <div class="form-group">
          <label>Quilometragem</label>
          <input type="number" name="km" step="1" min="0" placeholder="Ex: 45000" />
        </div>
        
        <div class="form-group">
          <label for="fotoInput">
            Fotos (m√°ximo 8)
            <span id="fotoCount" class="foto-count">0 selecionada(s)</span>
          </label>
          <input
            id="fotoInput"
            name="foto"
            type="file"
            accept="image/jpeg,image/jpg,image/png,image/webp"
            multiple
            title="Selecione at√© 8 fotos (Ctrl/Cmd + clique para selecionar m√∫ltiplas)"
          />
          <small style="color: #666; display: block; margin-top: 5px;">
            üí° Dica: Use Ctrl/Cmd + clique para selecionar m√∫ltiplas fotos
          </small>
          <div id="fotoPreview" class="foto-preview"></div>
        </div>
        
        <div class="form-group">
          <label>Descri√ß√£o</label>
          <textarea name="descricao" rows="3" placeholder="Informa√ß√µes adicionais..."></textarea>
        </div>
        
        <div class="form-actions">
          <button type="submit" class="btn primary">üíæ Salvar</button>
          <button type="button" class="btn ghost" onclick="window.history.back()">‚ùå Cancelar</button>
        </div>
      </form>
    </div>

    <script>
      // ========================================
      // PREVIEW DE M√öLTIPLAS FOTOS
      // ========================================
      (function () {
        const fotoInput = document.getElementById("fotoInput");
        const fotoPreview = document.getElementById("fotoPreview");
        const fotoCount = document.getElementById("fotoCount");

        if (!fotoInput || !fotoPreview) {
          console.error("‚ùå Elementos de foto n√£o encontrados!");
          return;
        }

        fotoInput.addEventListener("change", function (e) {
          const files = e.target.files;
          
          console.log(`üì∏ Evento change disparado`);
          console.log(`üìÅ Files object:`, files);
          console.log(`üî¢ Quantidade de arquivos: ${files ? files.length : 0}`);
          
          if (!files || files.length === 0) {
            console.warn("‚ö†Ô∏è Nenhum arquivo selecionado");
            renderizarPreview([]);
            return;
          }
          
          const filesArray = Array.from(files);
          console.log(`‚úÖ Arquivos convertidos para array: ${filesArray.length}`);
          console.log(`üìã Nomes:`, filesArray.map(f => f.name));
          
          if (filesArray.length > 8) {
            alert("M√°ximo de 8 fotos permitidas!");
            fotoInput.value = '';
            renderizarPreview([]);
            return;
          }
          
          const arquivosGrandes = filesArray.filter(f => f.size > 10 * 1024 * 1024);
          if (arquivosGrandes.length > 0) {
            alert(`${arquivosGrandes.length} arquivo(s) maior(es) que 10MB!`);
            fotoInput.value = '';
            renderizarPreview([]);
            return;
          }
          
          renderizarPreview(filesArray);
        });

        function renderizarPreview(files) {
          fotoPreview.innerHTML = '';
          fotoCount.textContent = `${files.length} selecionada(s)`;
          
          if (files.length === 0) {
            fotoPreview.classList.remove('show');
            return;
          }
          
          fotoPreview.classList.add('show');
          
          files.forEach((file, index) => {
            const url = URL.createObjectURL(file);
            
            const fotoItem = document.createElement('div');
            fotoItem.className = 'foto-item';
            
            const img = document.createElement('img');
            img.src = url;
            img.alt = `Foto ${index + 1}`;
            img.onload = () => URL.revokeObjectURL(url);
            
            const btnRemover = document.createElement('button');
            btnRemover.className = 'remover';
            btnRemover.innerHTML = '√ó';
            btnRemover.type = 'button';
            btnRemover.title = 'Remover foto';
            btnRemover.onclick = (e) => {
              e.preventDefault();
              removerFoto(index);
            };
            
            const ordem = document.createElement('span');
            ordem.className = 'ordem';
            ordem.textContent = `#${index + 1}`;
            
            fotoItem.appendChild(img);
            fotoItem.appendChild(btnRemover);
            fotoItem.appendChild(ordem);
            fotoPreview.appendChild(fotoItem);
          });
          
          console.log(`‚úÖ Preview renderizado: ${files.length} foto(s)`);
        }

        function removerFoto(index) {
          console.log(`üóëÔ∏è Removendo foto ${index + 1}`);
          
          const files = Array.from(fotoInput.files);
          files.splice(index, 1);
          
          const dt = new DataTransfer();
          files.forEach(file => dt.items.add(file));
          fotoInput.files = dt.files;
          
          renderizarPreview(files);
        }
      })();

      // ========================================
      // ENVIO DO FORMUL√ÅRIO COM PROGRESSO
      // ========================================
      (function () {
        const form = document.getElementById("formVeiculo");
        const progressContainer = document.getElementById("uploadProgress");
        const progressBar = document.getElementById("progressBar");
        const progressText = document.getElementById("progressText");
        const fotoInput = document.getElementById("fotoInput");
        
        if (!form) {
          console.error("‚ùå Formul√°rio n√£o encontrado!");
          return;
        }

        form.addEventListener("submit", function (e) {
          e.preventDefault();
          
          console.log("üì§ Iniciando envio do formul√°rio...");
          
          const endpoint = form.getAttribute("data-endpoint") || "/veiculos";
          const formData = new FormData(form);
          
          // ‚úÖ LOG DOS DADOS ENVIADOS
          console.log("\nüì¶ === DADOS DO FORMUL√ÅRIO ===");
          for (let [key, value] of formData.entries()) {
            if (key === 'foto') {
              if (value instanceof File) {
                console.log(`  üì∏ ${key}: ${value.name} (${(value.size / 1024).toFixed(2)} KB)`);
              }
            } else {
              console.log(`  üìù ${key}: ${value}`);
            }
          }
          
          // Valida√ß√µes
          const placa = formData.get('placa');
          if (placa && !/^[A-Z]{3}[0-9]{4}$|^[A-Z]{3}[0-9][A-Z][0-9]{2}$/i.test(placa)) {
            alert("Placa inv√°lida! Use formato ABC1234 ou ABC1D23");
            return;
          }
          
          const chassi = formData.get('chassi');
          if (chassi && chassi.length !== 17) {
            alert("Chassi deve ter 17 caracteres!");
            return;
          }
          
          const renavam = formData.get('renavam');
          if (renavam && renavam.length !== 11) {
            alert("RENAVAM deve ter 11 d√≠gitos!");
            return;
          }

          // Mostra barra de progresso
          progressContainer.classList.add('show');
          progressContainer.style.display = 'block';
          progressText.textContent = 'Enviando dados...';
          progressBar.style.width = '0%';
          progressBar.textContent = '0%';
          progressBar.style.background = 'linear-gradient(90deg, #22833d, #2f8f4a)';

          const xhr = new XMLHttpRequest();

          xhr.upload.addEventListener('progress', function(e) {
            if (e.lengthComputable) {
              const percent = Math.round((e.loaded / e.total) * 100);
              progressBar.style.width = percent + '%';
              progressBar.textContent = percent + '%';
              progressText.textContent = `Enviando... ${percent}%`;
            }
          });

          xhr.addEventListener('load', function() {
            console.log(`üì® Resposta recebida. Status: ${xhr.status}`);
            
            if (xhr.status >= 200 && xhr.status < 300) {
              progressBar.style.width = '100%';
              progressBar.textContent = '100%';
              progressText.textContent = '‚úÖ Ve√≠culo cadastrado com sucesso!';
              progressBar.style.background = 'linear-gradient(90deg, #22833d, #4caf50)';
              
              try {
                const response = JSON.parse(xhr.responseText);
                console.log('‚úÖ Resposta completa:', response);
                
                if (response.fotos) {
                  const msg = `Ve√≠culo cadastrado!\n\n${response.fotos.sucesso}/${response.fotos.total_enviadas} foto(s) enviada(s).`;
                  
                  if (response.fotos.lista_erros && response.fotos.lista_erros.length > 0) {
                    const erros = response.fotos.lista_erros.map(e => `- Foto ${e.index}: ${e.erro}`).join('\n');
                    alert(msg + '\n\nErros:\n' + erros);
                  } else {
                    alert(msg);
                  }
                } else {
                  alert('Ve√≠culo cadastrado com sucesso!');
                }
              } catch (e) {
                console.error('Erro ao parsear resposta:', e);
                alert('Ve√≠culo cadastrado com sucesso!');
              }
              
              setTimeout(() => {
                window.location.href = '/HTML/dashboard.html';
              }, 2000);
            } else {
              console.error('‚ùå Erro ao cadastrar. Status:', xhr.status);
              progressText.textContent = '‚ùå Erro ao cadastrar ve√≠culo';
              progressBar.style.background = '#d32f2f';
              
              try {
                const error = JSON.parse(xhr.responseText);
                console.error('Erro detalhado:', error);
                alert('Erro: ' + (error.message || error.body?.message || 'Falha ao cadastrar'));
              } catch (e) {
                alert('Erro ao cadastrar ve√≠culo. Status: ' + xhr.status);
              }
            }
          });

          xhr.addEventListener('error', function() {
            console.error('‚ùå Erro de rede');
            progressText.textContent = '‚ùå Erro de conex√£o';
            progressBar.style.background = '#d32f2f';
            alert('Erro de rede. Verifique sua conex√£o.');
          });

          xhr.open('POST', endpoint, true);
          xhr.send(formData);
          
          console.log("üì° Requisi√ß√£o enviada!");
        });
      })();
      
      // Auto-formata√ß√£o
      document.querySelector('input[name="placa"]')?.addEventListener('input', function(e) {
        this.value = this.value.toUpperCase();
      });
      
      document.querySelector('input[name="chassi"]')?.addEventListener('input', function(e) {
        this.value = this.value.toUpperCase();
      });
      
      document.querySelector('input[name="renavam"]')?.addEventListener('input', function(e) {
        this.value = this.value.replace(/\D/g, '');
      });
    </script>
  </body>
</html>