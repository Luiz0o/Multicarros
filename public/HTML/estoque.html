<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Estoque - Multicarros</title>
    <link rel="stylesheet" href="/css/estoque.css" />
  </head>
  <body>
    <!-- ‚¨ÖÔ∏è BOT√ÉO VOLTAR -->
    <div class="header-left">
      <button class="btn-voltar" id="btnVoltar">
        <span>‚Üê</span> Voltar
      </button>
    </div>

    <!-- üìã CABE√áALHO -->
    <header>
      <h1>Estoque Ve√≠culos</h1>
      <button class="btn-novo" id="btnNovoVeiculo">+ Novo Ve√≠culo</button>
    </header>

    <!-- üîç BUSCA E TABELA -->
    <div class="container">
      <div class="search-box">
        <input 
          type="text" 
          id="searchInput" 
          placeholder="üîç Buscar ve√≠culo por modelo, cor, placa..."
        />
      </div>

      <table id="tabelaVeiculo">
        <thead>
          <tr>
            <th>Modelo</th>
            <th>Cor</th>
            <th>Placa</th>
            <th>Marca</th>
            <th>Ano Fabrica√ß√£o</th>
            <th>Ano Modelo</th>
          </tr>
        </thead>
        <tbody>
          <!-- ‚è≥ Dados ser√£o carregados via JavaScript -->
          <tr>
            <td colspan="6" style="text-align: center; padding: 2rem;">
              Carregando ve√≠culos...
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- üìú SCRIPT DO ESTOQUE -->
    <script src="/JS/estoque.js"></script>
    
    <!-- üåê SCRIPT PARA CARREGAR VE√çCULOS DA API -->
    <script>
      (function () {
        console.log("üöÄ Iniciando carregamento de ve√≠culos...");
        
        const tbody = document.querySelector("#tabelaVeiculo tbody");
        const endpoint = "http://localhost:3000/veiculos";
        
        if (!tbody) {
          console.error("‚ùå Tbody n√£o encontrado");
          return;
        }

        function escapeHtml(s) {
          return String(s || "")
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
        }

        // üåê BUSCAR VE√çCULOS
        fetch(endpoint, { method: "GET" })
          .then((res) => {
            if (!res.ok) {
              throw new Error(`Erro HTTP ${res.status}: ${res.statusText}`);
            }
            return res.json();
          })
          .then((data) => {
            console.log(`‚úÖ ${data.length} ve√≠culo(s) recebido(s)`);
            
            if (!Array.isArray(data)) {
              console.warn("‚ö†Ô∏è Resposta inesperada:", data);
              tbody.innerHTML = `
                <tr>
                  <td colspan="6" style="text-align: center; color: #ff9800;">
                    ‚ö†Ô∏è Formato de dados inesperado
                  </td>
                </tr>
              `;
              return;
            }

            if (data.length === 0) {
              tbody.innerHTML = `
                <tr>
                  <td colspan="6" style="text-align: center; padding: 2rem;">
                    üì¶ Nenhum ve√≠culo cadastrado no estoque
                  </td>
                </tr>
              `;
              return;
            }

            // üé® RENDERIZAR VE√çCULOS
            tbody.innerHTML = "";
            
            data.forEach((v, index) => {
              // üöó Extrair dados do ve√≠culo
              const modelo = v.modelo || v.marcaModelo || v.marca_modelo || "---";
              const cor = v.cor || "---";
              const placa = v.placa || "---";
              const marca = v.marca || "---";
              const anoFab = v.fabricacao || v.anoFabricacao || v.ano_fabricacao || v.ano || "---";
              const anoModelo = v.ano_modelo || v.anoModelo || "---";
              
              // üìù Criar linha
              const tr = document.createElement("tr");
              tr.innerHTML = `
                <td>${escapeHtml(modelo)}</td>
                <td>${escapeHtml(cor)}</td>
                <td>${escapeHtml(placa)}</td>
                <td>${escapeHtml(marca)}</td>
                <td>${escapeHtml(anoFab)}</td>
                <td>${escapeHtml(anoModelo)}</td>
              `;
              
              tbody.appendChild(tr);
            });
            
            console.log("üéâ Ve√≠culos carregados com sucesso!");
          })
          .catch((err) => {
            console.error("‚ùå Erro ao carregar ve√≠culos:", err);
            tbody.innerHTML = `
              <tr>
                <td colspan="6" style="text-align: center; color: #f44336; padding: 2rem;">
                  ‚ùå Erro ao carregar ve√≠culos: ${escapeHtml(err.message)}
                  <br><br>
                  <small>Verifique se o servidor est√° rodando em http://localhost:3000</small>
                </td>
              </tr>
            `;
          });
      })();
    </script>
  </body>
</html>